//daffa, tolong ganti alamat ip dengan alamat ip komputer kamu, nah misal nodemcunya itu menyambung ke wifi yang sama dengan wifi laptop kamu
maka ip yang digunakan itu adalah ip yang ada tulisan "WIFI" nya, bisa di cek di terminal menggunakan "ipconfig". Namun misal nodemcunya itu menyambung ke hotspot laptop anda
maka ip yang digunakan itu adalah ip yang ada tulisan "local area connetion* <angka>".

//berikut kode mikrokontrollernya

#include <Servo.h>
#include <ESP8266WiFi.h>
#include <PubSubClient.h>

const char* ssid = "Rosyid";
const char* password = "qwertyuiop";
const char* mqtt_server = "192.168.137.1"; //ini ganti sesuai disclaimer yang saya tulis diatas
const char* mqtt_topic_sensor = "sensor";
const char* mqtt_topic_servo = "servo";
const char* mqtt_topic_nilaiSensor = "nilaiSensor";
char sensorValueStr[10];


const int sensorPin = A0;     // Pin analog sensor hujan
const int servoPin = D4;      // Pin servo
Servo myservo;                // Objek servo

WiFiClient espClient;
PubSubClient client(espClient);

void setup() {
  myservo.attach(servoPin);   // Hubungkan servo ke pin D4
  pinMode(sensorPin, INPUT);  // Set pin sensor sebagai input
  Serial.begin(9600);         // Aktifkan komunikasi serial

  setup_wifi();
  client.setServer(mqtt_server, 1883);
}

void setup_wifi() {
  delay(10);
  Serial.println();
  Serial.print("Connecting to WiFi");

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("");
  Serial.println("WiFi connected");
  Serial.println("IP address: ");
  Serial.println(WiFi.localIP());
}

void reconnect() {
  while (!client.connected()) {
    Serial.print("Attempting MQTT connection...");
    if (client.connect("ESP8266Client")) {
      Serial.println("connected");
    } else {
      Serial.print("failed, rc=");
      Serial.print(client.state());
      Serial.println(" try again in 5 seconds");
      delay(5000);
    }
  }
}

void loop() {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi connection lost. Reconnecting...");
    setup_wifi();
  }

  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  int sensorValue = analogRead(sensorPin);  // Baca nilai dari sensor hujan

  // Ubah nilai sensor menjadi ambang batas
  int threshold = 800;

  if (sensorValue >= threshold) {
    // Hujan terdeteksi, gerakkan servo ke posisi tertutup (misalnya, 90 derajat)
    myservo.write(180);
    Serial.println("Hujan terdeteksi. Servo terbuka.");
    Serial.print("Nilai sensor hujan: ");
    Serial.println(sensorValue);
    itoa(sensorValue, sensorValueStr, 10); //Konversi int to string
    client.publish(mqtt_topic_sensor, "Hujan tidak terdeteksi");
    client.publish(mqtt_topic_servo, "Terbuka");
    client.publish(mqtt_topic_nilaiSensor, sensorValueStr);
  } else {
    // Tidak ada hujan, gerakkan servo ke posisi terbuka (misalnya, 0 derajat)
    myservo.write(0);
    Serial.println("Tidak ada hujan. Servo tertutup.");
    Serial.print("Nilai sensor hujan: ");
    Serial.println(sensorValue);
    itoa(sensorValue, sensorValueStr, 10); //Konversi int to string
    client.publish(mqtt_topic_sensor, "Hujan terdeteksi");
    client.publish(mqtt_topic_servo, "Tertutup");
    client.publish(mqtt_topic_nilaiSensor, sensorValueStr);
  }

  delay(1000);  // Berhenti sejenak sebelum membaca ulang
}
